<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìì„¸ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 2em auto; line-height: 1.6; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
        .upload-form, .result-display { padding: 1.5em; border: 1px solid #ddd; border-radius: 8px; }
        h1, h2, h3 { color: #111; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.3em;}
        input[type="submit"] { padding: 0.5em 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;}
        input[type="submit"]:disabled { background-color: #cccccc; }
        .result-box { margin-top: 1em; padding: 1em; background-color: #f9f9f9; border-radius: 5px; }
        img { max-width: 100%; border-radius: 5px; margin-top: 1em; }
        .error { color: red; font-weight: bold; }
        b { color: #0056b3; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>êµ° ì¥ë³‘ ìì„¸ ë¶„ì„ ì‹œìŠ¤í…œ v3.0</h1>
    <a href="/history">ë¶„ì„ ê¸°ë¡ ë³´ê¸° â†’</a>
    <hr>
    
    <div class="container">
        <div class="upload-form">
            <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" name="file" id="fileInput" required>
                <input type="submit" id="submitBtn" value="ë¶„ì„ ì‹œì‘">
            </form>
        </div>

        <div class="result-display" id="result-display">
            <h2>ë¶„ì„ ê²°ê³¼</h2>
            <div id="result-content">
                <p>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

<script>
const EXPERT_KNOWLEDGE_BASE = {{ EXPERT_KNOWLEDGE_BASE|tojson|safe }};
const EXERCISE_PRESCRIPTION_DB = {{ EXERCISE_PRESCRIPTION_DB|tojson|safe }};
const uploadForm = document.getElementById('uploadForm');
const submitBtn = document.getElementById('submitBtn');
const resultDisplay = document.getElementById('result-content');

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.value = "ë¶„ì„ ì¤‘...";
    resultDisplay.innerHTML = `
        <p>ì„œë²„ë¡œ íŒŒì¼ì„ ì „ì†¡í•˜ê³  ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤... (ìµœëŒ€ 1~2ë¶„ ì†Œìš”)</p>
        <div class="loader"></div>
    `;

    const formData = new FormData();
    formData.append('file', document.getElementById('fileInput').files[0]);

    try {
        const response = await fetch('/', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) { throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨'); }
        const data = await response.json();
        checkStatus(data.task_id);
    } catch (error) {
        showError('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
    }
});

function checkStatus(taskId) {
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${taskId}`);
            const data = await response.json();

            if (data.status === 'ì„±ê³µ') {
                clearInterval(interval);
                displayResults(data.data);
            } else if (data.status === 'ë¶„ì„ ì‹¤íŒ¨') {
                clearInterval(interval);
                showError('ë¶„ì„ ì‹¤íŒ¨: ' + data.error);
            }
        } catch (error) {
            clearInterval(interval);
            showError('ê²°ê³¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        }
    }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
}

function displayResults(result) {
    let html = '';
    if (result.visualized_image_url) {
        // Render.comì˜ íŒŒì¼ ì‹œìŠ¤í…œì— ë§ê²Œ ê²½ë¡œë¥¼ ì¬êµ¬ì„±í•©ë‹ˆë‹¤.
        const originalImagePath = `/static/uploads/${result.path.split('/').pop()}`;
        const analyzedImagePath = `/static/${result.visualized_image_url}`;
        html += `<img src="${originalImagePath}" alt="ì›ë³¸ ì´ë¯¸ì§€">`;
        html += `<img src="${analyzedImagePath}" alt="ë¶„ì„ ê²°ê³¼ ì´ë¯¸ì§€">`;
    }
    
    html += `
        <div class="result-box">
            <h3>[ì¼ë°˜ ëª¨ë“œ]</h3>
            <p>ğŸ”¥ <b>ê·¼ê³¨ê²© ë¶€í•˜ ì ìˆ˜: ${result.load_score ? result.load_score.toFixed(1) : 'N/A'}</b></p>
            <p> 
                - í—ˆë¦¬: <b>${result.back_diagnosis || 'N/A'}</b> 
                  (ê°ë„: ${result.back_angle ? result.back_angle.toFixed(1) : 'N/A'}ë„) <br>
                - ë¬´ë¦: <b>${result.knee_diagnosis || 'N/A'}</b> 
                  (ê°ë„: ${result.knee_angle ? result.knee_angle.toFixed(1) : 'N/A'}ë„) <br>
                - ëª©: <b>${result.neck_diagnosis || 'N/A'}</b> 
                  (ê°ë„: ${result.neck_angle ? result.neck_angle.toFixed(1) : 'N/A'}ë„)
            </p>
        </div>
        <div class="result-box">
            <h3>[ì „ë¬¸ê°€ ëª¨ë“œ] ìƒì„¸ ì†Œê²¬</h3>`;

    ['back', 'knee', 'neck'].forEach(part => {
        const diag = result[part + '_diagnosis'];
        const pattern = result[part + '_pattern'] || 'ê¸°ë³¸';
        if ((diag === "ìœ„í—˜" || diag === "ì£¼ì˜") && EXPERT_KNOWLEDGE_BASE[part]?.[diag]?.[pattern]) {
            html += `
                <b>--- [${part.toUpperCase()}] ---</b>
                <p>â–¶ ì§„ë‹¨ íŒ¨í„´: ${pattern}</p>
                <p>- ì§„ë‹¨ëª…: ${EXPERT_KNOWLEDGE_BASE[part][diag][pattern]['ì§„ë‹¨ëª…']}</p>
            `;
        }
    });
    
    html += `</div><div class="result-box"><h3>[ê°œì¸ ë§ì¶¤í˜•] êµì • ìš´ë™ ì²˜ë°©</h3>`;

    ['back', 'knee', 'neck'].forEach(part => {
        const diag = result[part + '_diagnosis'];
        const pattern = result[part + '_pattern'] || 'ê¸°ë³¸';
        if ((diag === "ìœ„í—˜" || diag === "ì£¼ì˜") && EXERCISE_PRESCRIPTION_DB[part]?.[pattern]) {
            html += `<b>--- [${part.toUpperCase()} ê°œì„ ] ---</b>`;
            EXERCISE_PRESCRIPTION_DB[part][pattern].forEach(ex => {
                html += `<p>- ì¶”ì²œ ìš´ë™: ${ex['name']}</p>`;
            });
        }
    });

    html += `</div>`;
    
    resultDisplay.innerHTML = html;
    submitBtn.disabled = false;
    submitBtn.value = "ë¶„ì„ ì‹œì‘";
}

function showError(message) {
    resultDisplay.innerHTML = `<p class="error">${message}</p>`;
    submitBtn.disabled = false;
    submitBtn.value = "ë¶„ì„ ì‹œì‘";
}
</script>
</body>
</html>