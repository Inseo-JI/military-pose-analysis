<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#007bff"/>

    <meta charset="UTF-8">
    <title>ìì„¸ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 2em auto; line-height: 1.6; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
        .upload-form, .result-display { padding: 1.5em; border: 1px solid #ddd; border-radius: 8px; }
        h1, h2, h3 { color: #111; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.3em;}
        input[type="submit"] { padding: 0.5em 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;}
        .result-box { margin-top: 1em; padding: 1em; background-color: #f9f9f9; border-radius: 5px; }
        img { max-width: 100%; border-radius: 5px; margin-top: 1em; }
        .error { color: red; font-weight: bold; }
        b { color: #0056b3; }
    </style>
</head>
<body>
    <h1>êµ° ì¥ë³‘ ìì„¸ ë¶„ì„ ì‹œìŠ¤í…œ v2.0</h1>
    
    <div class="container">
        <div class="upload-form">
            <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>
            <form method="post" enctype="multipart/form-data">
                <input type="file" name="file" required>
                <input type="submit" value="ë¶„ì„ ì‹œì‘">
            </form>
            {% if error %}
                <p class="error">{{ error }}</p>
            {% endif %}
        </div>

        <div class="result-display">
            <h2>ë¶„ì„ ê²°ê³¼</h2>
            {% if result %}
                {% if result.status == 'ì„±ê³µ' %}
                    {% if result.visualized_image_url %}
                        <img src="{{ url_for('static', filename=result.visualized_image_url) }}" alt="ë¶„ì„ ê²°ê³¼ ì´ë¯¸ì§€">
                    {% endif %}
                    
                    <div class="result-box">
                        <h3>[ì¼ë°˜ ëª¨ë“œ]</h3>
                        <p>ğŸ”¥ <b>ê·¼ê³¨ê²© ë¶€í•˜ ì ìˆ˜: {{ '%.1f'|format(result.load_score) if result.load_score is not none else 'N/A' }}</b></p>
                        <p> 
                            - í—ˆë¦¬: <b>{{ result.back_diagnosis or 'N/A' }}</b> 
                              (ê°ë„: {{ '%.1f'|format(result.back_angle) if result.back_angle is not none else 'N/A' }}ë„) <br>
                            - ë¬´ë¦: <b>{{ result.knee_diagnosis or 'N/A' }}</b> 
                              (ê°ë„: {{ '%.1f'|format(result.knee_angle) if result.knee_angle is not none else 'N/A' }}ë„) <br>
                            - ëª©: <b>{{ result.neck_diagnosis or 'N/A' }}</b> 
                              (ê°ë„: {{ '%.1f'|format(result.neck_angle) if result.neck_angle is not none else 'N/A' }}ë„)
                        </p>
                    </div>

                    <div class="result-box">
                        <h3>[ì „ë¬¸ê°€ ëª¨ë“œ] ìƒì„¸ ì†Œê²¬</h3>
                        {% for part in ["back", "knee", "neck"] %}
                            {% set diag = result.get(part + '_diagnosis') %}
                            {% set pattern = result.get(part + '_pattern', 'ê¸°ë³¸') %}
                            {% if diag in ["ìœ„í—˜", "ì£¼ì˜"] and EXPERT_KNOWLEDGE_BASE.get(part, {}).get(diag, {}).get(pattern) %}
                                <b>--- [{{ part.upper() }}] ---</b>
                                <p>â–¶ ì§„ë‹¨ íŒ¨í„´: {{ pattern }}</p>
                                <p>- ì§„ë‹¨ëª…: {{ EXPERT_KNOWLEDGE_BASE[part][diag][pattern]['ì§„ë‹¨ëª…'] }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="result-box">
                        <h3>[ê°œì¸ ë§ì¶¤í˜•] êµì • ìš´ë™ ì²˜ë°©</h3>
                        {% for part in ["back", "knee", "neck"] %}
                            {% set diag = result.get(part + '_diagnosis') %}
                            {% set pattern = result.get(part + '_pattern', 'ê¸°ë³¸') %}
                            {% if diag in ["ìœ„í—˜", "ì£¼ì˜"] and EXERCISE_PRESCRIPTION_DB.get(part, {}).get(pattern) %}
                                <b>--- [{{ part.upper() }} ê°œì„ ] ---</b>
                                {% for ex in EXERCISE_PRESCRIPTION_DB[part][pattern] %}
                                    <p>- ì¶”ì²œ ìš´ë™: {{ ex['name'] }}</p>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </div>

                {% else %}
                    <p class="error"><b>ë¶„ì„ ì‹¤íŒ¨:</b> {{ result.status }}</p>
                {% endif %}
            {% else %}
                <p>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>
</html>