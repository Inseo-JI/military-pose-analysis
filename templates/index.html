<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#007bff"/>

    <meta charset="UTF-8">
    <title>자세 분석 시스템</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 2em auto; line-height: 1.6; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
        .upload-form, .result-display { padding: 1.5em; border: 1px solid #ddd; border-radius: 8px; }
        h1, h2, h3 { color: #111; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.3em;}
        input[type="submit"] { padding: 0.5em 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;}
        .result-box { margin-top: 1em; padding: 1em; background-color: #f9f9f9; border-radius: 5px; }
        img { max-width: 100%; border-radius: 5px; margin-top: 1em; }
        .error { color: red; font-weight: bold; }
        b { color: #0056b3; }
    </style>
</head>
<body>
    <h1>군 장병 자세 분석 시스템 v2.0</h1>
    
    <div class="container">
        <div class="upload-form">
            <h2>사진 업로드</h2>
            <form method="post" enctype="multipart/form-data">
                <input type="file" name="file" required>
                <input type="submit" value="분석 시작">
            </form>
            {% if error %}
                <p class="error">{{ error }}</p>
            {% endif %}
        </div>

        <div class="result-display">
            <h2>분석 결과</h2>
            {% if result %}
                {% if result.status == '성공' %}
                    {% if result.visualized_image_url %}
                        <img src="{{ url_for('static', filename=result.visualized_image_url) }}" alt="분석 결과 이미지">
                    {% endif %}
                    
                    <div class="result-box">
                        <h3>[일반 모드]</h3>
                        <p>🔥 <b>근골격 부하 점수: {{ '%.1f'|format(result.load_score) if result.load_score is not none else 'N/A' }}</b></p>
                        <p> 
                            - 허리: <b>{{ result.back_diagnosis or 'N/A' }}</b> 
                              (각도: {{ '%.1f'|format(result.back_angle) if result.back_angle is not none else 'N/A' }}도) <br>
                            - 무릎: <b>{{ result.knee_diagnosis or 'N/A' }}</b> 
                              (각도: {{ '%.1f'|format(result.knee_angle) if result.knee_angle is not none else 'N/A' }}도) <br>
                            - 목: <b>{{ result.neck_diagnosis or 'N/A' }}</b> 
                              (각도: {{ '%.1f'|format(result.neck_angle) if result.neck_angle is not none else 'N/A' }}도)
                        </p>
                    </div>

                    <div class="result-box">
                        <h3>[전문가 모드] 상세 소견</h3>
                        {% for part in ["back", "knee", "neck"] %}
                            {% set diag = result.get(part + '_diagnosis') %}
                            {% set pattern = result.get(part + '_pattern', '기본') %}
                            {% if diag in ["위험", "주의"] and EXPERT_KNOWLEDGE_BASE.get(part, {}).get(diag, {}).get(pattern) %}
                                <b>--- [{{ part.upper() }}] ---</b>
                                <p>▶ 진단 패턴: {{ pattern }}</p>
                                <p>- 진단명: {{ EXPERT_KNOWLEDGE_BASE[part][diag][pattern]['진단명'] }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="result-box">
                        <h3>[개인 맞춤형] 교정 운동 처방</h3>
                        {% for part in ["back", "knee", "neck"] %}
                            {% set diag = result.get(part + '_diagnosis') %}
                            {% set pattern = result.get(part + '_pattern', '기본') %}
                            {% if diag in ["위험", "주의"] and EXERCISE_PRESCRIPTION_DB.get(part, {}).get(pattern) %}
                                <b>--- [{{ part.upper() }} 개선] ---</b>
                                {% for ex in EXERCISE_PRESCRIPTION_DB[part][pattern] %}
                                    <p>- 추천 운동: {{ ex['name'] }}</p>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </div>

                {% else %}
                    <p class="error"><b>분석 실패:</b> {{ result.status }}</p>
                {% endif %}
            {% else %}
                <p>사진을 업로드하면 여기에 결과가 표시됩니다.</p>
            {% endif %}
        </div>
    </div>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>
</html>