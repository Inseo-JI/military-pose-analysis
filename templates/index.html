<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>자세 분석 시스템</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 2em auto; line-height: 1.6; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
        .upload-form, .result-display { padding: 1.5em; border: 1px solid #ddd; border-radius: 8px; }
        h1, h2, h3 { color: #111; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.3em;}
        input[type="submit"] { padding: 0.5em 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;}
        input[type="submit"]:disabled { background-color: #cccccc; }
        .result-box { margin-top: 1em; padding: 1em; background-color: #f9f9f9; border-radius: 5px; }
        img { max-width: 100%; border-radius: 5px; margin-top: 1em; }
        .error { color: red; font-weight: bold; }
        b { color: #0056b3; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>군 장병 자세 분석 시스템 v3.0</h1>
    <a href="/history">분석 기록 보기 →</a>
    <hr>
    
    <div class="container">
        <div class="upload-form">
            <h2>사진 업로드</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" name="file" id="fileInput" required>
                <input type="submit" id="submitBtn" value="분석 시작">
            </form>
        </div>

        <div class="result-display" id="result-display">
            <h2>분석 결과</h2>
            <div id="result-content">
                <p>사진을 업로드하면 여기에 결과가 표시됩니다.</p>
            </div>
        </div>
    </div>

<script>
const EXPERT_KNOWLEDGE_BASE = {{ EXPERT_KNOWLEDGE_BASE|tojson|safe }};
const EXERCISE_PRESCRIPTION_DB = {{ EXERCISE_PRESCRIPTION_DB|tojson|safe }};
const uploadForm = document.getElementById('uploadForm');
const submitBtn = document.getElementById('submitBtn');
const resultDisplay = document.getElementById('result-content');

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.value = "분석 중...";
    resultDisplay.innerHTML = `
        <p>서버로 파일을 전송하고 분석을 시작합니다... (최대 1~2분 소요)</p>
        <div class="loader"></div>
    `;

    const formData = new FormData();
    formData.append('file', document.getElementById('fileInput').files[0]);

    try {
        const response = await fetch('/', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) { throw new Error('파일 업로드 실패'); }
        const data = await response.json();
        checkStatus(data.task_id);
    } catch (error) {
        showError('업로드 중 오류 발생: ' + error.message);
    }
});

function checkStatus(taskId) {
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${taskId}`);
            const data = await response.json();

            if (data.status === '성공') {
                clearInterval(interval);
                displayResults(data.data);
            } else if (data.status === '분석 실패') {
                clearInterval(interval);
                showError('분석 실패: ' + data.error);
            }
        } catch (error) {
            clearInterval(interval);
            showError('결과 확인 중 오류 발생: ' + error.message);
        }
    }, 5000); // 5초마다 상태 확인
}

function displayResults(result) {
    let html = '';
    if (result.visualized_image_url) {
        // Render.com의 파일 시스템에 맞게 경로를 재구성합니다.
        const originalImagePath = `/static/uploads/${result.path.split('/').pop()}`;
        const analyzedImagePath = `/static/${result.visualized_image_url}`;
        html += `<img src="${originalImagePath}" alt="원본 이미지">`;
        html += `<img src="${analyzedImagePath}" alt="분석 결과 이미지">`;
    }
    
    html += `
        <div class="result-box">
            <h3>[일반 모드]</h3>
            <p>🔥 <b>근골격 부하 점수: ${result.load_score ? result.load_score.toFixed(1) : 'N/A'}</b></p>
            <p> 
                - 허리: <b>${result.back_diagnosis || 'N/A'}</b> 
                  (각도: ${result.back_angle ? result.back_angle.toFixed(1) : 'N/A'}도) <br>
                - 무릎: <b>${result.knee_diagnosis || 'N/A'}</b> 
                  (각도: ${result.knee_angle ? result.knee_angle.toFixed(1) : 'N/A'}도) <br>
                - 목: <b>${result.neck_diagnosis || 'N/A'}</b> 
                  (각도: ${result.neck_angle ? result.neck_angle.toFixed(1) : 'N/A'}도)
            </p>
        </div>
        <div class="result-box">
            <h3>[전문가 모드] 상세 소견</h3>`;

    ['back', 'knee', 'neck'].forEach(part => {
        const diag = result[part + '_diagnosis'];
        const pattern = result[part + '_pattern'] || '기본';
        if ((diag === "위험" || diag === "주의") && EXPERT_KNOWLEDGE_BASE[part]?.[diag]?.[pattern]) {
            html += `
                <b>--- [${part.toUpperCase()}] ---</b>
                <p>▶ 진단 패턴: ${pattern}</p>
                <p>- 진단명: ${EXPERT_KNOWLEDGE_BASE[part][diag][pattern]['진단명']}</p>
            `;
        }
    });
    
    html += `</div><div class="result-box"><h3>[개인 맞춤형] 교정 운동 처방</h3>`;

    ['back', 'knee', 'neck'].forEach(part => {
        const diag = result[part + '_diagnosis'];
        const pattern = result[part + '_pattern'] || '기본';
        if ((diag === "위험" || diag === "주의") && EXERCISE_PRESCRIPTION_DB[part]?.[pattern]) {
            html += `<b>--- [${part.toUpperCase()} 개선] ---</b>`;
            EXERCISE_PRESCRIPTION_DB[part][pattern].forEach(ex => {
                html += `<p>- 추천 운동: ${ex['name']}</p>`;
            });
        }
    });

    html += `</div>`;
    
    resultDisplay.innerHTML = html;
    submitBtn.disabled = false;
    submitBtn.value = "분석 시작";
}

function showError(message) {
    resultDisplay.innerHTML = `<p class="error">${message}</p>`;
    submitBtn.disabled = false;
    submitBtn.value = "분석 시작";
}
</script>
</body>
</html>